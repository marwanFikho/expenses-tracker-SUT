<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expense Tracker - Login</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="content" style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
    <div class="auth-container">
      <div class="card" style="max-width: 400px; width: 100%;">
        <h1 style="text-align: center; margin-bottom: 24px;">Expense Tracker</h1>

        <div id="authMode" class="auth-mode-login form">
          <!-- Login form -->
          <div id="loginForm">
            <h2>Login</h2>
            <input id="loginEmail" type="email" placeholder="Email" />
            <input id="loginPassword" type="password" placeholder="Password" />
            <button class="primary" onclick="login()" style="width: 100%;">Login</button>
            <p style="text-align: center; margin-top: 16px;">
              Don't have an account? <a href="#" onclick="switchToRegister(event)">Register</a>
            </p>
          </div>

          <!-- Register form -->
          <div id="registerForm" style="display: none;">
            <h2>Create Account</h2>
            <input id="regEmail" type="email" placeholder="Email" />
            <input id="regPassword" type="password" placeholder="Password (min 6 chars)" />
            <input id="regPasswordConfirm" type="password" placeholder="Confirm Password" />
            <button class="primary" onclick="register()" style="width: 100%;">Register</button>
            <p style="text-align: center; margin-top: 16px;">
              Already have an account? <a href="#" onclick="switchToLogin(event)">Login</a>
            </p>
          </div>

          <div id="errorMsg" style="color: #d63343; margin-top: 16px; text-align: center; display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
      const API_BASE = 'api.php';

      async function login() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorEl = document.getElementById('errorMsg');

        if (!email || !password) {
          showError('Email and password required');
          return;
        }

        try {
          const res = await fetch(`${API_BASE}?path=auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          const data = await res.json();

          if (!res.ok) {
            showError(data.error || 'Login failed');
            return;
          }

          localStorage.setItem('token', data.token);
          localStorage.setItem('user_id', data.user_id);
          window.location.href = 'index.html';
        } catch (err) {
          console.error(err);
          showError('Network error. Try again.');
        }
      }

      async function register() {
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;
        const confirm = document.getElementById('regPasswordConfirm').value;
        const errorEl = document.getElementById('errorMsg');

        if (!email || !password || !confirm) {
          showError('All fields required');
          return;
        }

        if (password !== confirm) {
          showError('Passwords do not match');
          return;
        }

        if (password.length < 6) {
          showError('Password must be at least 6 characters');
          return;
        }

        try {
          const res = await fetch(`${API_BASE}?path=auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          const data = await res.json();

          if (!res.ok) {
            showError(data.error || 'Registration failed');
            return;
          }

          localStorage.setItem('token', data.token);
          localStorage.setItem('user_id', data.user_id);
          window.location.href = 'index.html';
        } catch (err) {
          console.error(err);
          showError('Network error. Try again.');
        }
      }

      function switchToRegister(e) {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
        document.getElementById('errorMsg').style.display = 'none';
      }

      function switchToLogin(e) {
        e.preventDefault();
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('errorMsg').style.display = 'none';
      }

      function showError(msg) {
        const errorEl = document.getElementById('errorMsg');
        errorEl.textContent = msg;
        errorEl.style.display = 'block';
      }

      window.onload = () => {
        const token = localStorage.getItem('token');
        if (token) {
          window.location.href = 'index.html';
        }
      };
  </script>
</body>
</html>
